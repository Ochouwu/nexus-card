
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus Card</title>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 2rem; text-align: center; }
    input, button { padding: 0.5rem; border-radius: 0.5rem; border: none; margin: 0.5rem; width: 80%; max-width: 300px; }
    button:hover { background-color: #444; cursor: pointer; }
    button:active { transform: scale(0.98); }
    .hidden { display: none; }
    .card { background: #222; padding: 1rem; margin: 1rem auto; border-radius: 1rem; width: 90%; max-width: 400px; }
    img { width: 100px; border-radius: 0.5rem; }
    .acciones { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-top: 0.5rem; }
    .success { color: lightgreen; }
    .warning { color: gold; }
    .error { color: red; }
  </style>
</head>
<body>

<div id="login">
  <h1><img src="logo.png" alt="Logo" style="width:30px; vertical-align:middle; margin-right:8px;">Login</h1>
  <input type="text" id="userID" placeholder="Tu ID autorizado" />
  <button id="entrarBtn">Entrar</button>
  <div id="msgAcceso" class="warning"></div>
</div>

<form id="formulario" class="hidden" style="display: flex; flex-direction: column; align-items: center;">
  <h2><img src="logo.png" alt="Logo" style="width:30px; vertical-align:middle; margin-right:8px;">Solicitar Nexus Card</h2>
  <input type="text" id="campoID" placeholder="ID" required />
  <input type="text" id="apodo" placeholder="Apodo" required />
  <input type="text" id="usuario" placeholder="Usuario" required />
  <input type="text" id="pais" placeholder="País" required />
  <input type="date" id="nacimiento" placeholder="Fecha de nacimiento" required />
  <input type="file" id="imagen" accept="image/*" required />
  <button type="submit" id="enviarBtn">Enviar solicitud</button>
  <div id="mensaje" class="success"></div>
</form>

<button id="adminBtn" style="margin-top:2rem;">🔒 Modo administrador</button>
<div id="admin" class="hidden" style="display: flex; flex-direction: column; align-items: center;">
  <h2>Solicitudes recibidas</h2>
  <div id="solicitudes"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqk6oERAq0SyC8lTqilWNQRDb-HWiHV6U",
    authDomain: "nexus-club-770fd.firebaseapp.com",
    projectId: "nexus-club-770fd",
    storageBucket: "nexus-club-770fd.firebasestorage.app",
    messagingSenderId: "1042965614720",
    appId: "1:1042965614720:web:64908a801e59fd6bb75665"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const autorizados = ["676640620852281364"];
  let currentID = "";

  document.getElementById("entrarBtn").addEventListener("click", async () => {
    const inputID = document.getElementById("userID").value.trim();
    if (!autorizados.includes(inputID)) {
      document.getElementById("msgAcceso").textContent = "❌ Acceso no autorizado";
      return;
    }
    currentID = inputID;
    const snap = await getDocs(collection(db, "solicitudes"));
    let solicitud = null;
    snap.forEach(doc => { if (doc.id === inputID) solicitud = doc.data(); });

    if (!solicitud) {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("formulario").classList.remove("hidden");
      return;
    }

    if (solicitud.estado === "Pendiente") {
      document.getElementById("msgAcceso").textContent = "⏳ Tu solicitud está pendiente de aprobación";
    } else if (solicitud.estado === "Aprobado") {
      document.getElementById("msgAcceso").textContent = "✅ Tu solicitud fue aprobada";
    } else {
      document.getElementById("msgAcceso").textContent = "❌ Acceso no autorizado";
    }
  });

  document.getElementById("formulario").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentID) return alert("Error: ID no válido.");

    const apodo = document.getElementById("apodo").value;
    const usuario = document.getElementById("usuario").value;
    const pais = document.getElementById("pais").value;
    const nacimiento = document.getElementById("nacimiento").value;
    const campoID = document.getElementById("campoID").value;
    const imgFile = document.getElementById("imagen").files[0];
    if (!imgFile || !campoID || !apodo || !usuario || !pais || !nacimiento) {
      alert("Todos los campos son obligatorios.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = async function() {
        const canvas = document.createElement("canvas");
        const maxSize = 400;
        const scale = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7);

        const datos = { id: campoID, apodo, usuario, pais, nacimiento, imagen: compressedBase64, estado: "Pendiente" };
        try {
          await setDoc(doc(db, "solicitudes", currentID), datos);
          document.getElementById("mensaje").textContent = "✅ Solicitud enviada para aprobación";
          document.getElementById("enviarBtn").disabled = true;
        } catch (error) {
          alert("Error al enviar la solicitud.");
        }
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(imgFile);
  });

  document.getElementById("adminBtn").addEventListener("click", () => {
    const pass = prompt("Ingresa la clave de administrador:");
    if (pass !== "Prefijo_123") return alert("Clave incorrecta.");
    document.getElementById("admin").classList.remove("hidden");
    cargarAdmin();
  });

  async function cargarAdmin() {
    const cont = document.getElementById("solicitudes");
    cont.innerHTML = "";
    const snap = await getDocs(collection(db, "solicitudes"));
    snap.forEach((docSnap) => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <img src="${d.imagen}" />
        <p><strong>ID:</strong> ${d.id}</p>
        <p><strong>Apodo:</strong> ${d.apodo}</p>
        <p><strong>Usuario:</strong> ${d.usuario}</p>
        <p><strong>País:</strong> ${d.pais}</p>
        <p><strong>Nacimiento:</strong> ${d.nacimiento}</p>
        <p><strong>Estado:</strong> ${d.estado}</p>
        <div class="acciones">
          ${d.estado === "Pendiente" ? `<button onclick="aprobar('${docSnap.id}')">Aprobar</button>` : `<span style="color:lightgreen;">✅ Aprobado</span>`}
          <button onclick="eliminar('${docSnap.id}')">Eliminar</button>
          <a href="${d.imagen}" download="imagen_${d.id}.jpg"><button>Descargar imagen</button></a>
        </div>
      `;
      cont.appendChild(div);
    });
  }

  window.aprobar = async function(id) {
    const ref = doc(db, "solicitudes", id);
    const snap = await getDocs(collection(db, "solicitudes"));
    snap.forEach(async docSnap => {
      if (docSnap.id === id) {
        const d = docSnap.data();
        await setDoc(ref, { ...d, estado: "Aprobado" });
        cargarAdmin();
      }
    });
  }

  window.eliminar = async function(id) {
    await deleteDoc(doc(db, "solicitudes", id));
    cargarAdmin();
  }
</script>

</body>
</html>
