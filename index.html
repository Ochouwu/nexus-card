
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus Card</title>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 2rem; text-align: center; }
    input, button { padding: 0.5rem; border-radius: 0.5rem; border: none; margin: 0.5rem; width: 80%; max-width: 300px; }
    .hidden { display: none; }
    .card { background: #222; padding: 1rem; margin: 1rem auto; border-radius: 1rem; width: 90%; max-width: 400px; }
    img { width: 100px; border-radius: 0.5rem; }
    .acciones button { margin: 0.25rem; }
    .success { color: lightgreen; }
    .warning { color: gold; }
    .error { color: red; }
  </style>
</head>
<body>

<div id="login">
  <h1>Solicita tu Nexus Card</h1>
  <input type="text" id="userID" placeholder="Tu ID autorizado" />
  <button id="entrarBtn">Entrar</button>
  <div id="msgAcceso" class="warning"></div>
</div>

<form id="formulario" class="hidden">
  <h2>Formulario de Solicitud</h2>
  <input type="text" id="campoID" placeholder="ID" required />
  <input type="text" id="apodo" placeholder="Apodo" required />
  <input type="text" id="usuario" placeholder="Usuario" required />
  <input type="text" id="pais" placeholder="PaÃ­s" required />
  <input type="file" id="imagen" accept="image/*" required />
  <button type="submit" id="enviarBtn">Enviar solicitud</button>
  <div id="mensaje" class="success"></div>
</form>

<button id="adminBtn" style="margin-top:2rem;">ðŸ”’ Modo administrador</button>
<div id="admin" class="hidden">
  <h2>Solicitudes recibidas</h2>
  <div id="solicitudes"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqk6oERAq0SyC8lTqilWNQRDb-HWiHV6U",
    authDomain: "nexus-club-770fd.firebaseapp.com",
    projectId: "nexus-club-770fd",
    storageBucket: "nexus-club-770fd.firebasestorage.app",
    messagingSenderId: "1042965614720",
    appId: "1:1042965614720:web:64908a801e59fd6bb75665"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const autorizados = ["676640620852281364"];
  let currentID = "";

  document.getElementById("entrarBtn").addEventListener("click", async () => {
    const inputID = document.getElementById("userID").value.trim();
    if (!autorizados.includes(inputID)) {
      document.getElementById("msgAcceso").textContent = "âŒ Acceso no autorizado";
      return;
    }
    currentID = inputID;
    const ref = doc(db, "solicitudes", inputID);
    const snap = await getDocs(collection(db, "solicitudes"));
    let solicitud = null;
    snap.forEach(doc => { if (doc.id === inputID) solicitud = doc.data(); });

    if (!solicitud) {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("formulario").classList.remove("hidden");
      return;
    }

    if (solicitud.estado === "Pendiente") {
      document.getElementById("msgAcceso").textContent = "â³ Tu solicitud estÃ¡ pendiente de aprobaciÃ³n";
    } else if (solicitud.estado === "Aprobado") {
      document.getElementById("msgAcceso").textContent = "âœ… Tu solicitud fue aprobada";
    } else {
      document.getElementById("msgAcceso").textContent = "âŒ Acceso no autorizado";
    }
  });

  document.getElementById("formulario").addEventListener("submit", async (e) => {
    e.preventDefault();
    const apodo = document.getElementById("apodo").value;
    const usuario = document.getElementById("usuario").value;
    const pais = document.getElementById("pais").value;
    const campoID = document.getElementById("campoID").value;
    const imgFile = document.getElementById("imagen").files[0];
    if (!imgFile) return alert("Imagen requerida");

    const reader = new FileReader();
    reader.onload = async function(event) {
      const base64 = event.target.result;
      const datos = { id: campoID, apodo, usuario, pais, imagen: base64, estado: "Pendiente" };
      await setDoc(doc(db, "solicitudes", currentID), datos);
      document.getElementById("mensaje").textContent = "âœ… Solicitud enviada para aprobaciÃ³n";
      document.getElementById("enviarBtn").disabled = true;
    };
    reader.readAsDataURL(imgFile);
  });

  document.getElementById("adminBtn").addEventListener("click", () => {
    const pass = prompt("Ingresa la clave de administrador:");
    if (pass !== "Prefijo_123") return alert("Clave incorrecta.");
    document.getElementById("admin").classList.remove("hidden");
    cargarAdmin();
  });

  async function cargarAdmin() {
    const cont = document.getElementById("solicitudes");
    cont.innerHTML = "";
    const snap = await getDocs(collection(db, "solicitudes"));
    snap.forEach((docSnap) => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <img src="${d.imagen}" />
        <p><strong>ID:</strong> ${d.id}</p>
        <p><strong>Apodo:</strong> ${d.apodo}</p>
        <p><strong>Usuario:</strong> ${d.usuario}</p>
        <p><strong>PaÃ­s:</strong> ${d.pais}</p>
        <p><strong>Estado:</strong> ${d.estado}</p>
        <div class="acciones">
          ${d.estado === "Pendiente" ? `<button onclick="aprobar('${docSnap.id}')">Aprobar</button>` : `<span style="color:lightgreen;">âœ… Aprobado</span>`}
          <button onclick="eliminar('${docSnap.id}')">Eliminar</button>
          <a href="${d.imagen}" download="imagen_${d.id}.png"><button>Descargar imagen</button></a>
        </div>
      `;
      cont.appendChild(div);
    });
  }

  window.aprobar = async function(id) {
    const ref = doc(db, "solicitudes", id);
    const snap = await getDocs(collection(db, "solicitudes"));
    snap.forEach(async docSnap => {
      if (docSnap.id === id) {
        const d = docSnap.data();
        await setDoc(ref, { ...d, estado: "Aprobado" });
        cargarAdmin();
      }
    });
  }

  window.eliminar = async function(id) {
    await deleteDoc(doc(db, "solicitudes", id));
    cargarAdmin();
  }
</script>

</body>
</html>
